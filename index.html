
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–£—á—ë—Ç —Ç–æ–≤–∞—Ä–æ–≤ + –°–∫–∞–Ω–µ—Ä + OCR</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    input, button, select { margin: 5px 0; padding: 5px; width: 100%; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    tr.expiring { background-color: #ffdddd; }
    tr.low-demand { background-color: #ffffcc; }
    #chart-container { margin-top: 30px; }
  </style>
</head>
<body>
  <h2>–£—á–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ + –®—Ç—Ä–∏—Ö–∫–æ–¥-—Å–∫–∞–Ω–µ—Ä + –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
  <a href="ocr.html" style="display:block; margin: 10px 0;">üì∑ –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—é —Å —Ñ–æ—Ç–æ (OCR)</a>

  <label for="mode">–†–µ–∂–∏–º —Å–∫–∞–Ω–µ—Ä–∞:</label>
  <select id="mode">
    <option value="in">–ü—Ä–∏–µ–º–∫–∞ (–ø—Ä–∏–±–∞–≤–∏—Ç—å)</option>
    <option value="out">–ü—Ä–æ–¥–∞–∂–∞ (–≤—ã—á–µ—Å—Ç—å)</option>
  </select>

  <div id="salePanel" style="display:none;">
    <label for="productSelect">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä:</label>
    <select id="productSelect" onchange="onProductSelect()">
      <option value="">‚Äî</option>
    </select>
    <button onclick="sellProduct()">–ü—Ä–æ–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
  </div>

  <input id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
  <input id="barcode" placeholder="–®—Ç—Ä–∏—Ö–∫–æ–¥ (–æ—Ç —Å–∫–∞–Ω–µ—Ä–∞)">
  <input id="price" placeholder="–¶–µ–Ω–∞" type="number">
  <input id="qty" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" type="number">
  <input id="expiry" placeholder="–ì–æ–¥–µ–Ω –¥–æ (–ì–ì–ì–ì-–ú–ú-–î–î)" type="date">
  <button onclick="addProduct()">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
  <button onclick="saveData()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button onclick="loadData()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  <button onclick="exportJSON()">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
  <button onclick="exportExcel()">üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
  <button onclick="analyzeDemand()">üìà –ê–Ω–∞–ª–∏–∑ —Å–ø—Ä–æ—Å–∞</button>
  <button onclick="printReceipt()">üßæ –ü–µ—á–∞—Ç—å —á–µ–∫–∞</button>

  <table id="productTable">
    <thead>
      <tr>
        <th>–¢–æ–≤–∞—Ä</th>
        <th>–®—Ç—Ä–∏—Ö–∫–æ–¥</th>
        <th>–¶–µ–Ω–∞</th>
        <th>–ö–æ–ª-–≤–æ</th>
        <th>–ì–æ–¥–µ–Ω –¥–æ</th>
        <th>–£–¥–∞–ª–∏—Ç—å</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="chart-container">
    <canvas id="salesChart" width="800" height="400"></canvas>
  </div>

  <script>
    let products = [];
    const beep = new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg');

    document.getElementById('mode').addEventListener('change', function () {
      const mode = this.value;
      const salePanel = document.getElementById('salePanel');
      if (mode === 'out') {
        salePanel.style.display = 'block';
        populateProductSelect();
      } else {
        salePanel.style.display = 'none';
      }
    });

    function populateProductSelect() {
      const select = document.getElementById('productSelect');
      select.innerHTML = '<option value="">‚Äî</option>';
      products.forEach((p, i) => {
        select.innerHTML += `<option value="${i}">${p.name} (${p.qty} —à—Ç.)</option>`;
      });
    }

    function onProductSelect() {
      const index = document.getElementById('productSelect').value;
      if (index !== '') {
        const p = products[index];
        document.getElementById('name').value = p.name;
        document.getElementById('barcode').value = p.barcode;
        document.getElementById('price').value = p.price;
        document.getElementById('qty').value = 1;
        document.getElementById('expiry').value = p.expiry || '';
      }
    }

    function sellProduct() {
      const index = document.getElementById('productSelect').value;
      const qtyToSell = parseInt(document.getElementById('qty').value);
      if (index === '' || isNaN(qtyToSell) || qtyToSell <= 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –∏ —É–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
        return;
      }

      const p = products[index];
      if (p.qty < qtyToSell) {
        alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ');
        return;
      }

      p.qty -= qtyToSell;
      const today = new Date().toISOString().split('T')[0];
      p.sales = p.sales || [];
      for (let i = 0; i < qtyToSell; i++) p.sales.push(today);

      if (p.qty === 0) products.splice(index, 1);
      renderTable();
      populateProductSelect();
    }

    function renderTable() {
      const tbody = document.querySelector('#productTable tbody');
      tbody.innerHTML = '';
      const today = new Date();
      products.forEach((p, i) => {
        const row = document.createElement('tr');
        const expiry = p.expiry ? new Date(p.expiry) : null;
        if (expiry && (expiry - today) / (1000 * 60 * 60 * 24) <= 3) {
          row.classList.add('expiring');
        } else if (p.sales && p.sales.length <= 3) {
          row.classList.add('low-demand');
        }
        const discount = expiry && (expiry - today) / (1000 * 60 * 60 * 24) <= 3 ? ' (–°–∫–∏–¥–∫–∞ -50%)' : '';
        row.innerHTML = `
          <td>${p.name}${discount}</td>
          <td>${p.barcode}</td>
          <td>${p.price}</td>
          <td>${p.qty}</td>
          <td>${p.expiry || ''}</td>
          <td><button onclick="deleteProduct(${i})">–£–¥–∞–ª–∏—Ç—å</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function addProduct() {
      const name = document.getElementById('name').value.trim();
      const barcode = document.getElementById('barcode').value.trim();
      const price = parseFloat(document.getElementById('price').value);
      const qty = parseInt(document.getElementById('qty').value);
      const expiry = document.getElementById('expiry').value;
      if (!name || !barcode || isNaN(price) || isNaN(qty)) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
        return;
      }
      const existing = products.find(p => p.barcode === barcode);
      if (existing) {
        existing.qty += qty;
        if (expiry) existing.expiry = expiry;
      } else {
        products.push({ name, barcode, price, qty, expiry, sales: [] });
      }
      document.getElementById('name').value = '';
      document.getElementById('barcode').value = '';
      document.getElementById('price').value = '';
      document.getElementById('qty').value = '';
      document.getElementById('expiry').value = '';
      renderTable();
    }

    function deleteProduct(index) {
      products.splice(index, 1);
      renderTable();
    }

    function saveData() {
      localStorage.setItem('products', JSON.stringify(products));
      alert('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    }

    function loadData() {
      const data = localStorage.getItem('products');
      if (data) {
        products = JSON.parse(data);
        renderTable();
        alert('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
      }
    }

    function exportJSON() {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(products));
      const dl = document.createElement('a');
      dl.setAttribute("href", dataStr);
      dl.setAttribute("download", "products.json");
      dl.click();
    }

    function exportExcel() {
      const worksheet = XLSX.utils.json_to_sheet(products);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "–¢–æ–≤–∞—Ä—ã");
      XLSX.writeFile(workbook, "products.xlsx");
    }

    function analyzeDemand() {
      const now = new Date();
      products.forEach(p => {
        if (!p.sales) return;
        const last30 = p.sales.filter(date => (now - new Date(date)) <= 30 * 24 * 60 * 60 * 1000);
        p.sales = last30;
      });
      renderTable();
      drawChart();
      alert('–ê–Ω–∞–ª–∏–∑ —Å–ø—Ä–æ—Å–∞ –∑–∞–≤–µ—Ä—à—ë–Ω.');
    }

    function drawChart() {
      const ctx = document.getElementById('salesChart').getContext('2d');
      const labels = products.map(p => p.name);
      const data = products.map(p => (p.sales ? p.sales.length : 0));
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: '–ü—Ä–æ–¥–∞–∂–∏ –∑–∞ 30 –¥–Ω–µ–π',
            data,
            borderWidth: 1
          }]
        }
      });
    }

    function printReceipt() {
      const soldItems = [];
      const today = new Date().toISOString().split('T')[0];
      products.forEach(p => {
        if (p.sales) {
          const todaySales = p.sales.filter(date => date === today).length;
          if (todaySales > 0) {
            soldItems.push({
              name: p.name,
              qty: todaySales,
              price: p.price,
              total: p.price * todaySales
            });
          }
        }
      });

      if (soldItems.length === 0) {
        alert("–ù–µ—Ç –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –ø–µ—á–∞—Ç–∏ —á–µ–∫–∞.");
        return;
      }

      const totalSum = soldItems.reduce((sum, item) => sum + item.total, 0).toFixed(2);

      const wnd = window.open('', '–ß–µ–∫', 'width=300,height=600');
      wnd.document.write(`
        <html>
          <head>
            <style>
              body { font-family: monospace; font-size: 12px; margin: 0; padding: 10px; }
              h2 { text-align: center; }
              table { width: 100%; border-collapse: collapse; margin-top: 10px; }
              td { padding: 2px 0; }
              .right { text-align: right; }
            </style>
          </head>
          <body>
            <h2>–ú–ê–ì–ê–ó–ò–ù "–£ –î–û–ú–ê"</h2>
            <p>${new Date().toLocaleString()}</p>
            <hr>
            <table>
              ${soldItems.map(item => `
                <tr>
                  <td>${item.name} x${item.qty}</td>
                  <td class="right">${item.total.toFixed(2)} ‚ÇΩ</td>
                </tr>
              `).join('')}
            </table>
            <hr>
            <p class="right"><strong>–ò–¢–û–ì–û: ${totalSum} ‚ÇΩ</strong></p>
            <p>–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!</p>
          </body>
        </html>
      `);
      wnd.document.close();
      wnd.focus();
      wnd.print();
      wnd.close();
    }
  </script>
</body>
</html>
