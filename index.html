
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–£—á–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ + –®—Ç—Ä–∏—Ö–∫–æ–¥-—Å–∫–∞–Ω–µ—Ä</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    input, button, select { margin: 5px 0; padding: 5px; width: 100%; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    tr.expiring { background-color: #ffdddd; }
    tr.low-demand { background-color: #ffffcc; }
    #chart-container { margin-top: 30px; }
#scannerPreview {
  width: 100%;
  max-width: 400px;
  height: 300px;
  overflow: hidden;
  position: relative;
  background: #000;
}

#scannerPreview video, 
#scannerPreview canvas {
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;
  display: block;
}
  </style>
</head>
<body>
  <h2>–£—á–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ + –®—Ç—Ä–∏—Ö–∫–æ–¥-—Å–∫–∞–Ω–µ—Ä + –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
<button onclick="location.href='ocr.html'">üì∑ –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—é –∞–∫—Ç–∞</button>
  <h3>üì∑ –°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤</h3>
  <select id="cameraSelect"></select>
  <div id="scannerPreview"></div></div>
  <button onclick="restartScanner()">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>

  <label for="mode">–†–µ–∂–∏–º —Å–∫–∞–Ω–µ—Ä–∞:</label>
  <select id="mode">
    <option value="in">–ü—Ä–∏–µ–º–∫–∞ (–ø—Ä–∏–±–∞–≤–∏—Ç—å)</option>
    <option value="out">–ü—Ä–æ–¥–∞–∂–∞ (–≤—ã—á–µ—Å—Ç—å)</option>
  </select>

  <div id="salePanel" style="display:none;">
    <label for="productSelect">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä:</label>
    <select id="productSelect" onchange="onProductSelect()">
      <option value="">‚Äî</option>
    </select>
    <button onclick="sellProduct()">–ü—Ä–æ–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
  </div>

  <input id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
  <input id="barcode" placeholder="–®—Ç—Ä–∏—Ö–∫–æ–¥ (–æ—Ç —Å–∫–∞–Ω–µ—Ä–∞)">
  <input id="price" placeholder="–¶–µ–Ω–∞" type="number">
  <input id="qty" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" type="number">
  <input id="expiry" placeholder="–ì–æ–¥–µ–Ω –¥–æ (–ì–ì–ì–ì-–ú–ú-–î–î)" type="date">
  <button onclick="addProduct()">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
  <button onclick="saveData()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button onclick="loadData()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  <button onclick="exportJSON()">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
  <button onclick="exportExcel()">üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
  <button onclick="analyzeDemand()">üìà –ê–Ω–∞–ª–∏–∑ —Å–ø—Ä–æ—Å–∞</button>
  <button onclick="printReceipt()">üßæ –ü–µ—á–∞—Ç—å —á–µ–∫–∞</button>

  <table id="productTable">
    <thead>
      <tr>
        <th>–¢–æ–≤–∞—Ä</th>
        <th>–®—Ç—Ä–∏—Ö–∫–æ–¥</th>
        <th>–¶–µ–Ω–∞</th>
        <th>–ö–æ–ª-–≤–æ</th>
        <th>–ì–æ–¥–µ–Ω –¥–æ</th>
        <th>–£–¥–∞–ª–∏—Ç—å</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="chart-container">
    <canvas id="salesChart" width="800" height="400"></canvas>
  </div>

  <script>
    let products = [];
    let scannerActive = false;
    let selectedDeviceId = null;
    const beep = new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg');

    function startScanner() {
      if (scannerActive) {
        Quagga.stop();
      }

      Quagga.init({
        inputStream: {
          type: "LiveStream",
          constraints: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: "environment",
            deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined,
            advanced: [{ focusMode: "continuous" }]
          },
          target: document.querySelector('#scannerPreview')
        },
        locator: { patchSize: "medium", halfSample: true },
        numOfWorkers: navigator.hardwareConcurrency || 4,
        decoder: {
          readers: ["ean_reader", "ean_8_reader", "code_128_reader"]
        },
        locate: true
      }, err => {
        if (err) {
          console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∫–∞–Ω–µ—Ä–∞:", err);
          return;
        }
        Quagga.start();
        scannerActive = true;
      });

      Quagga.onDetected(data => {
        const code = data.codeResult.code;
        document.getElementById("barcode").value = code;
        beep.play();
        Quagga.stop();
        scannerActive = false;
      });
    }

    function restartScanner() {
      startScanner();
    }

    function listCameras() {
      navigator.mediaDevices.enumerateDevices()
        .then(devices => {
          const select = document.getElementById('cameraSelect');
          select.innerHTML = '';
          devices.forEach(device => {
            if (device.kind === 'videoinput') {
              const option = document.createElement('option');
              option.value = device.deviceId;
              option.text = device.label || `–ö–∞–º–µ—Ä–∞ ${select.length + 1}`;
              select.appendChild(option);
            }
          });
          selectedDeviceId = select.value;
          startScanner();
        });
    }

    document.getElementById('cameraSelect').addEventListener('change', function () {
      selectedDeviceId = this.value;
      startScanner();
    });

    window.addEventListener('load', listCameras);
  </script>
</body>
</html>
